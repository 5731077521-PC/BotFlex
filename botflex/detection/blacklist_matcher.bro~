##! This script looks for possible CnC communication between our hosts
##! and a botnet CnC server. For the time being, we look at (i) blacklist matches
##! (ii) high dns failure rate which hints at botnets that use domain flux (domain
##! generation algorithm <http://en.wikipedia.org/wiki/Domain_Generation_Algorithm> ) 

@load botflex/detection/exploit/exploit

event connection_established( c: connection )
	{
	local our_ip: addr;
	local other_ip: addr;
	local outbound = Site::is_local_addr(c$id$orig_h);

	our_ip = outbound? c$id$orig_h: c$id$resp_h;
	other_ip = outbound? c$id$resp_h: c$id$orig_h;

	## See if there is a match in IP blacklist
	if ( [other_ip,"Exploit"] in BlacklistMgr::blacklist_ip )
		{
		event Exploit::ip_blacklist_match( our_ip: addr, other_ip )	
		}
	## Otherwise, check in subnet blacklist
	else
		{
		for ( [ bad_subnet, reason ] in BlacklistMgr::blacklist_subnet )
			{
			event Exploit::ip_blacklist_match( our_ip: addr, other_ip )
			}
		}

	
	}



